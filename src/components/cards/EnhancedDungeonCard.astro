---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import { getDifficultyInfo, getPlayersText } from '../../utils/dungeonUtils';

interface Props {
  dungeon: CollectionEntry<'donjons'>;
  modalId: string;
}

const { dungeon, modalId } = Astro.props;
const difficultyInfo = getDifficultyInfo(dungeon.data.difficulty);
const playersText = getPlayersText(dungeon.data.players, dungeon.data.playersCount);

// Add fallbacks for potentially missing image/icon data
const imageSrc = dungeon.data.image?.src ?? '/images/donjons/default-banner.jpg';
const imageAlt = dungeon.data.image?.alt ?? dungeon.data.name ?? 'BanniÃ¨re par dÃ©faut';
const iconSrc = dungeon.data.icon?.src ?? '/images/donjons/default-icon.png';
const iconAlt = dungeon.data.icon?.alt ?? 'IcÃ´ne par dÃ©faut';
---

<div 
  class="dungeon-card group glass-card rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 flex flex-col h-full transform hover:-translate-y-1 hover:scale-[1.02]"
>
  <div class="relative">
    <Image
      src={imageSrc}
      alt={imageAlt}
      width={600}
      height={300}
      class="w-full h-48 object-cover"
      format="webp"
      loading="lazy"
    />
    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4">
      <h3 class="text-white text-xl font-bold truncate">{dungeon.data.name}</h3>
    </div>
    <div class={`absolute top-2 right-2 text-xs font-semibold px-2 py-1 rounded border ${difficultyInfo.color} border-opacity-50`}>
      {difficultyInfo.label}
    </div>
  </div>

  <div class="p-6 flex flex-col flex-grow">
    <div class="flex items-center mb-4">
      <div class={`bg-gray-500/20 dark:bg-gray-700/30 p-2 rounded-full mr-3 flex-shrink-0`}>
        <Image
          src={iconSrc}
          alt={iconAlt}
          width={32}
          height={32}
          class="w-8 h-8"
          format="webp"
          loading="lazy"
        />
      </div>
      <div class="flex flex-col min-w-0">
        <span class="text-gray-600 dark:text-gray-300 font-medium truncate">
          Niveau {dungeon.data.level}
        </span>
        <span class="text-gray-500 dark:text-gray-400 text-sm truncate">
          {dungeon.data.region}
        </span>
      </div>
    </div>

    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-3 flex-grow">
      {dungeon.data.description}
    </p>

    <!-- Badges pour les salles et le nombre de joueurs -->
    <div class="flex flex-wrap gap-2 mb-4">
      {dungeon.data.playersCount && (
        <span class="text-xs px-2 py-0.5 bg-indigo-900/60 text-indigo-200 rounded-full border border-indigo-700/50 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          {dungeon.data.playersCount} joueurs
        </span>
      )}
      
      {dungeon.data.rooms && (
        <span class="text-xs px-2 py-0.5 bg-pink-900/60 text-pink-200 rounded-full border border-pink-700/50 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          {dungeon.data.rooms} salle{dungeon.data.rooms > 1 ? 's' : ''}
        </span>
      )}
    </div>
    
    <div class="flex justify-between items-center mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
      <!-- Type d'Ã©quipe avec le nombre exact de joueurs -->
      <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
        <span class="flex items-center">
          <span class="mr-1">{dungeon.data.players === 'solo' ? 'ðŸ‘¤' : 'ðŸ‘¥'}</span> 
          {playersText}
        </span>
      </div>
      
      <!-- Lien direct vers la page du donjon -->
      <a 
        href={`/donjons/${dungeon.slug}`}
        class="text-wakfu-primary dark:text-wakfu-secondary font-medium text-sm group-hover:underline flex items-center"
        aria-label={`Voir les dÃ©tails de ${dungeon.data.name}`}
      >
        DÃ©tails
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1 transition-transform group-hover:translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </div>
</div>

<style>
  .glass-card {
    background: rgba(17, 25, 40, 0.7);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
</style>
