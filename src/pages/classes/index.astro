---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';
import Modal from '../../components/ui/Modal.astro';

// Récupérer les classes depuis la collection
const classes = (await getCollection('classes')).sort((a, b) => a.data.name.localeCompare(b.data.name));

// Définir les couleurs pour chaque rôle
const roleColors = {
  'Tank': 'text-blue-300 bg-blue-900/50 border-blue-500/50',
  'Support': 'text-green-300 bg-green-900/50 border-green-500/50',
  'DPT': 'text-red-300 bg-red-900/50 border-red-500/50',
  'DPT distance': 'text-orange-300 bg-orange-900/50 border-orange-500/50',
  'DPT mêlée': 'text-yellow-300 bg-yellow-900/50 border-yellow-500/50',
  'Tank/DPT': 'text-purple-300 bg-purple-900/50 border-purple-500/50',
  'Healer, Support': 'text-emerald-300 bg-emerald-900/50 border-emerald-500/50',
};

---

<MainLayout title="Classes de Wakfu" description="Découvrez toutes les classes jouables dans Wakfu, leurs caractéristiques, spécialités et guides">
  <div class="container mx-auto px-4 py-12">
    <h1 class="text-5xl font-bold mb-4 text-center text-gradient-primary">Les Classes de Wakfu</h1>
    
    <p class="text-lg mb-10 max-w-3xl mx-auto text-center text-[var(--color-text-muted)]">
      Explorez les 18 classes uniques de Wakfu. Découvrez leurs sorts, passifs et styles de jeu pour trouver celle qui vous correspond.
    </p>

    <!-- Liste des classes - Glassmorphism Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12" id="classes-container">
      {classes.map((clazz, index) => {

        const roleStyle = roleColors[clazz.data.role] || 'text-gray-300 bg-gray-700/50 border-gray-500/50';
        const animationDelay = `${index * 0.07}s`;
        
        return (
          <div 
            class="class-card glass rounded-xl overflow-hidden shadow-lg transition-all duration-300 hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] hover:-translate-y-1 animate-fade-up flex flex-col h-full"
            style={`animation-delay: ${animationDelay};`}
          >
            <div class="p-6 relative z-10 flex flex-col h-full">
              {/* En-tête */}
              <div class="flex items-center gap-4 mb-4">
                <img 
                  src={clazz.data.icon.src} 
                  alt={clazz.data.icon.alt}
                  class="w-16 h-16 rounded-lg border border-[var(--color-border-muted)]"
                />
                <div>
                  <h3 class="text-xl font-bold text-white">{clazz.data.name}</h3>
                </div>
              </div>
              
              {/* Description */}
              <p class="text-[var(--color-text-muted)] mb-4 flex-grow">{clazz.data.description || 'Aucune description disponible'}</p>
              
              {/* Étiquettes */}
              <div class="flex flex-col items-center gap-4 mb-6">
                <div class="flex gap-3 justify-center">
                  <img src="/images/ability/dps.png" alt="DPS" class="w-9 h-9 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                  <img src="/images/ability/tank.png" alt="Tank" class="w-9 h-9 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                  <img src="/images/ability/controle.png" alt="Contrôle" class="w-9 h-9 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                </div>
                <div class="text-xs text-primary">{clazz.data.specialty}</div>
              </div>

              {/* Bouton voir plus - maintenant dans un conteneur mt-auto pour le placer en bas */}
              <div class="mt-auto flex justify-center">
                <button
                  class="btn btn-primary text-sm py-1.5 px-3 flex items-center gap-1 group"
                  data-modal-target={`modal-${clazz.data.id}`}
                >
                  En savoir plus
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform group-hover:translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </div>

  {/* Modales pour chaque classe */}
  {classes.map(clazz => {
    const roleStyle = roleColors[clazz.data.role] || 'text-gray-300 bg-gray-700/50 border-gray-500/50';
    
    return (
      <Modal
        id={`modal-${clazz.data.id}`}
        title={clazz.data.name}
        size="lg"
      >
        {/* Structure verticale avec défilement */}
        <div class="overflow-y-auto max-h-[75vh] pr-2 space-y-6">
          {/* Informations générales */}
          <div class="space-y-6">
            {/* En-tête avec icône et description */}
            <div class="flex flex-col space-y-4">
              <div class="flex items-start gap-4">
                <img 
                  src={clazz.data.icon.src} 
                  alt={clazz.data.icon.alt}
                  class="w-16 h-16 rounded-lg border border-[var(--color-border-muted)] transform transition-transform duration-300 hover:scale-105"
                />
                <div>
                  <h2 class="text-2xl font-bold text-white">{clazz.data.name}</h2>
                  <div class="mt-4 flex flex-col items-center gap-3">
                    <div class="flex gap-3 justify-center">
                      <img src="/images/ability/dps.png" alt="DPS" class="w-10 h-10 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                      <img src="/images/ability/tank.png" alt="Tank" class="w-10 h-10 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                      <img src="/images/ability/controle.png" alt="Contrôle" class="w-10 h-10 rounded-full border-2 border-[var(--color-border-muted)] hover:scale-110 transition-transform" />
                    </div>
                    <span class="inline-block px-2 py-0.5 rounded-full text-xs bg-gray-700 text-white border border-gray-600">{clazz.data.combatStyle}</span>
                  </div>
                </div>
              </div>
              
              <div class="text-sm text-[var(--color-text-muted)]">
                {clazz.data.detailedDescription ? `${clazz.data.detailedDescription.substring(0, 120)}...` : 'Aucune description détaillée disponible'}
              </div>
            </div>
            
            {/* Forces et Faiblesses */}
            <div class="space-y-4">
              <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                <h4 class="text-base font-semibold text-emerald-400 mb-1 flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                  </svg>
                  Forces
                </h4>
                <ul class="list-disc list-inside text-sm text-[var(--color-text-muted)]">
                  {clazz.data.strengths?.split(', ').map(strength => (
                    <li>{strength}</li>
                  ))}
                </ul>
              </div>
              <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                <h4 class="text-base font-semibold text-red-400 mb-1 flex items-center gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                  </svg>
                  Faiblesses
                </h4>
                <ul class="list-disc list-inside text-sm text-[var(--color-text-muted)]">
                  {clazz.data.weaknesses?.split(', ').map(weakness => (
                    <li>{weakness}</li>
                  ))}
                </ul>
              </div>
            </div>
            
            {/* Passif unique */}
            <div>
              <h3 class="text-xl font-semibold mb-2 text-primary">Passif Unique</h3>
              <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                <div class="flex items-center gap-2 mb-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 text-yellow-400">
                    <path fill-rule="evenodd" d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401z" clip-rule="evenodd" />
                  </svg>
                  <h4 class="text-base font-semibold text-yellow-300">{clazz.data.uniquePassive?.name || 'Passif unique'}</h4>
                </div>
                <p class="text-sm text-[var(--color-text-muted)]">{clazz.data.uniquePassive?.description || 'Aucune description disponible'}</p>
              </div>
            </div>

            {/* Builds recommandés */}
            {clazz.data.builds && clazz.data.builds.length > 0 && (
              <div>
                <h3 class="text-xl font-semibold mb-2 text-primary">Builds</h3>
                <div class="space-y-3">
                {clazz.data.builds?.map(build => (
                  <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                    <div>
                      <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                          <h5 class="font-semibold text-white text-sm">{build.name}</h5>
                          {build.playstyle && (
                            <span class={`text-xs px-1.5 py-0.5 rounded-full ${
                              build.playstyle === 'Agressif' ? 'bg-red-900/50 text-red-300 border border-red-500/50' :
                              build.playstyle === 'Défensif' ? 'bg-blue-900/50 text-blue-300 border border-blue-500/50' :
                              'bg-purple-900/50 text-purple-300 border border-purple-500/50'
                            }`}>
                              {build.playstyle}
                            </span>
                          )}
                        </div>
                        <span class="text-xs text-primary">Niv. {build.minLevel}+</span>
                      </div>
                      <div class="text-xs px-1.5 py-0.5 rounded-full bg-primary/10 text-primary inline-block mb-1">{build.type}</div>
                      <p class="text-xs text-[var(--color-text-muted)]">{build.description}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>
            )}
          </div>
          
          {/* Sorts principaux et passifs */}
          <div class="space-y-6">
            {/* Sorts principaux */}
            <div>
              <h3 class="text-xl font-semibold mb-3 text-primary">Sorts Principaux</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {clazz.data.mainSpells?.map(spell => (
                  <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                    <div class="flex gap-3">
                      <img 
                        src={spell.image.src} 
                        alt={spell.image.alt}
                        class="w-10 h-10 rounded-md border border-[var(--color-border-muted)] flex-shrink-0"
                      />
                      <div>
                        <div class="flex items-center gap-2">
                          <h5 class="font-semibold text-white text-sm">{spell.name}</h5>
                          <span class="text-xs px-1.5 py-0.5 rounded-full bg-primary/20 text-primary">Niv. {spell.level}</span>
                        </div>
                        <p class="text-xs text-[var(--color-text-muted)] mt-1">{spell.description}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Sorts passifs par catégorie */}
            <div>
              <h3 class="text-xl font-semibold mb-3 text-primary">Sorts Passifs</h3>
              
              {/* Regrouper les passifs par catégorie */}
              {['Offensif', 'Défensif', 'Réactif'].map(category => {
                const passivesInCategory = clazz.data.passiveSpells?.filter(spell => 
                  spell.category === category || (!spell.category && category === 'Offensif')
                ) || [];
                
                if (passivesInCategory.length === 0) return null;
                
                return (
                  <div class="mb-4">
                    <div class="flex items-center gap-2 mb-2">
                      <div class={`w-3 h-3 rounded-full ${
                        category === 'Offensif' ? 'bg-red-400' : 
                        category === 'Défensif' ? 'bg-blue-400' : 'bg-amber-400'
                      }`}></div>
                      <h4 class="text-sm font-semibold text-white">{category}</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {passivesInCategory?.map(spell => (
                        <div class="glass p-3 rounded-xl hover:shadow-primary/20 hover:border-[var(--color-border-highlight)] transition-all duration-300">
                          <div class="flex gap-3">
                            <img 
                              src={spell.image.src} 
                              alt={spell.image.alt}
                              class="w-10 h-10 rounded-md border border-[var(--color-border-muted)] flex-shrink-0"
                            />
                            <div>
                              <h5 class="font-semibold text-white text-sm mb-1">{spell.name}</h5>
                              <p class="text-xs text-[var(--color-text-muted)]">{spell.description}</p>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </Modal>
    );
  })}
</MainLayout>

<style>
  .animate-fade-up {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeUp 0.5s ease-out forwards;
  }

  @keyframes fadeUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
